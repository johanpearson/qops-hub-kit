# Common Resources Pipeline
# Deploys shared Key Vault for JWT secrets across dev, test, and prod environments
# This should be run once to set up the shared infrastructure

name: Deploy Common Resources

trigger: none # Manual trigger only
pr: none

parameters:
  - name: deployToDev
    displayName: 'Deploy to DEV'
    type: boolean
    default: true

  - name: deployToTest
    displayName: 'Deploy to TEST'
    type: boolean
    default: false

  - name: deployToProd
    displayName: 'Deploy to PROD'
    type: boolean
    default: false

variables:
  - name: location
    value: 'swedencentral'
  - name: azureSubscription
    value: 'Azure-Connection' # Update with your Azure DevOps service connection name

  # Link to variable groups containing secrets
  - group: qops-common-secrets-dev
  - group: qops-common-secrets-test
  - group: qops-common-secrets-prod

stages:
  # Deploy to DEV
  - stage: DeployDev
    displayName: 'Deploy Common Resources to DEV'
    condition: eq('${{ parameters.deployToDev }}', true)
    jobs:
      - job: DeployCommonDev
        displayName: 'Deploy Key Vault and Common Resources'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout repository'

          - task: AzureCLI@2
            displayName: 'Deploy Common Resources to DEV'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying common resources to DEV environment"

                DEPLOYMENT_NAME="common-dev-$(Build.BuildId)"

                az deployment sub create \
                  --name $DEPLOYMENT_NAME \
                  --location $(location) \
                  --template-file infra/common-resources.bicep \
                  --parameters environment=dev \
                  --parameters location=$(location) \
                  --parameters jwtSecret="$(JWT_SECRET_DEV)"

                echo ""
                echo "âœ… Common resources deployed to DEV!"
                echo ""

                # Get deployment outputs
                KEY_VAULT_NAME=$(az deployment sub show \
                  --name $DEPLOYMENT_NAME \
                  --query properties.outputs.keyVaultName.value -o tsv)

                KEY_VAULT_URI=$(az deployment sub show \
                  --name $DEPLOYMENT_NAME \
                  --query properties.outputs.keyVaultUri.value -o tsv)

                echo "Key Vault Name: $KEY_VAULT_NAME"
                echo "Key Vault URI: $KEY_VAULT_URI"
                echo ""
                echo "ðŸ’¡ Note: JWT secret has been stored in Key Vault as 'jwt-secret'"

  # Deploy to TEST
  - stage: DeployTest
    displayName: 'Deploy Common Resources to TEST'
    dependsOn: DeployDev
    condition: eq('${{ parameters.deployToTest }}', true)
    jobs:
      - deployment: DeployCommonTest
        displayName: 'Deploy Key Vault and Common Resources'
        environment: test # Requires approval in Azure DevOps
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout repository'

                - task: AzureCLI@2
                  displayName: 'Deploy Common Resources to TEST'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying common resources to TEST environment"

                      DEPLOYMENT_NAME="common-test-$(Build.BuildId)"

                      az deployment sub create \
                        --name $DEPLOYMENT_NAME \
                        --location $(location) \
                        --template-file infra/common-resources.bicep \
                        --parameters environment=test \
                        --parameters location=$(location) \
                        --parameters jwtSecret="$(JWT_SECRET_TEST)"

                      echo ""
                      echo "âœ… Common resources deployed to TEST!"
                      echo ""

                      # Get deployment outputs
                      KEY_VAULT_NAME=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query properties.outputs.keyVaultName.value -o tsv)

                      KEY_VAULT_URI=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query properties.outputs.keyVaultUri.value -o tsv)

                      echo "Key Vault Name: $KEY_VAULT_NAME"
                      echo "Key Vault URI: $KEY_VAULT_URI"

  # Deploy to PROD
  - stage: DeployProd
    displayName: 'Deploy Common Resources to PROD'
    dependsOn: DeployTest
    condition: eq('${{ parameters.deployToProd }}', true)
    jobs:
      - deployment: DeployCommonProd
        displayName: 'Deploy Key Vault and Common Resources'
        environment: prod # Requires approval in Azure DevOps
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout repository'

                - task: AzureCLI@2
                  displayName: 'Deploy Common Resources to PROD'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying common resources to PROD environment"

                      DEPLOYMENT_NAME="common-prod-$(Build.BuildId)"

                      az deployment sub create \
                        --name $DEPLOYMENT_NAME \
                        --location $(location) \
                        --template-file infra/common-resources.bicep \
                        --parameters environment=prod \
                        --parameters location=$(location) \
                        --parameters jwtSecret="$(JWT_SECRET_PROD)"

                      echo ""
                      echo "âœ… Common resources deployed to PROD!"
                      echo ""

                      # Get deployment outputs
                      KEY_VAULT_NAME=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query properties.outputs.keyVaultName.value -o tsv)

                      KEY_VAULT_URI=$(az deployment sub show \
                        --name $DEPLOYMENT_NAME \
                        --query properties.outputs.keyVaultUri.value -o tsv)

                      echo "Key Vault Name: $KEY_VAULT_NAME"
                      echo "Key Vault URI: $KEY_VAULT_URI"

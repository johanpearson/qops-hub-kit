name: Publish Package

trigger: none
pr: none

pool:
  vmImage: ubuntu-latest

variables:
  nodeVersion: '22.x'

jobs:
  - job: PublishPackage
    displayName: Build and publish
    steps:
      - checkout: self

      - task: NodeTool@0
        displayName: Use Node.js $(nodeVersion)
        inputs:
          versionSpec: $(nodeVersion)

      - task: NpmAuthenticate@0
        displayName: Authenticate npm to Azure Artifacts
        inputs:
          workingFile: .npmrc

      - script: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")

          echo "Package: $PKG_NAME"
          echo "Version: $PKG_VERSION"

          echo "##vso[task.setvariable variable=PackageName]$PKG_NAME"
          echo "##vso[task.setvariable variable=PackageVersion]$PKG_VERSION"
        displayName: Read package metadata

      - script: |
          echo "Checking if $(PackageName)@$(PackageVersion) already exists..."
          EXISTING=$(npm view "$(PackageName)@$(PackageVersion)" version 2>/dev/null || true)

          if [ -n "$EXISTING" ]; then
            echo "$(PackageName)@$(PackageVersion) is already published."
            exit 1
          fi

          echo "Not published yet — continuing."
        displayName: Fail if version already published

      - script: npm ci
        displayName: Install dependencies

      - script: npm run typecheck
        displayName: Typecheck

      - script: npm run build
        displayName: Build

      - script: npm run test:coverage
        displayName: Test (coverage)

      - task: PublishTestResults@2
        displayName: Publish test results
        condition: succeededOrFailed()
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: '**/junit.xml'
          failTaskOnFailedTests: true
          testRunTitle: Unit Tests

      - task: PublishCodeCoverageResults@2
        displayName: Publish code coverage
        condition: succeededOrFailed()
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: '$(Build.SourcesDirectory)/coverage/cobertura-coverage.xml'
          reportDirectory: '$(Build.SourcesDirectory)/coverage'
          failIfCoverageEmpty: true

      - script: npm publish
        displayName: Publish to Azure Artifacts

      - bash: |
          echo "✅ Published $(PackageName)@$(PackageVersion)"
        displayName: Publish summary

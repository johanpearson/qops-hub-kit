name: Publish Package

# Manual trigger only
trigger: none

# Manual trigger with version bump parameter
parameters:
  - name: versionBump
    displayName: 'Version Bump Type'
    type: string
    default: 'patch'
    values:
      - patch
      - minor
      - major

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'
  # IMPORTANT: Update this to match your Azure Artifacts feed name
  artifactFeedName: 'qops-feed'

jobs:
  - job: PublishPackage
    displayName: 'Version, Build, and Publish'
    steps:
      # Setup Node.js
      - task: NodeTool@0
        displayName: 'Setup Node.js $(nodeVersion)'
        inputs:
          versionSpec: '$(nodeVersion)'

      # Install dependencies
      - task: Npm@1
        displayName: 'Install dependencies'
        inputs:
          command: 'ci'

      # Configure git for version commit
      - bash: |
          git config user.email "azure-pipelines@noreply.example.com"
          git config user.name "Azure Pipelines"
        displayName: 'Configure Git'

      # Bump version
      - bash: |
          npm version ${{ parameters.versionBump }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "##vso[task.setvariable variable=PackageVersion]$NEW_VERSION"
        displayName: 'Bump Version'

      # Run quality checks
      - task: Npm@1
        displayName: 'Run Linting'
        inputs:
          command: 'custom'
          customCommand: 'run lint'

      - task: Npm@1
        displayName: 'Build Package'
        inputs:
          command: 'custom'
          customCommand: 'run build'

      - task: Npm@1
        displayName: 'Run Tests'
        inputs:
          command: 'custom'
          customCommand: 'test'

      # Commit and push version change (only after all checks pass)
      - bash: |
          git add package.json package-lock.json
          git commit -m "chore: bump version to $(PackageVersion) [skip ci]"
          git push origin HEAD:$(Build.SourceBranchName)
        displayName: 'Commit and Push Version'

      # Create and push git tag
      - bash: |
          git tag -a "v$(PackageVersion)" -m "Release v$(PackageVersion)"
          git push origin "v$(PackageVersion)"
        displayName: 'Create and Push Git Tag'

      # Publish to Azure Artifacts
      - task: Npm@1
        displayName: 'Publish to Azure Artifacts'
        inputs:
          command: 'publish'
          publishRegistry: 'useFeed'
          publishFeed: '$(artifactFeedName)'

      # Success message
      - bash: |
          echo "‚úÖ Successfully published version $(PackageVersion) to Azure Artifacts feed: $(artifactFeedName)"
          echo "üì¶ Package: @qops/hub-kit@$(PackageVersion)"
          echo "üè∑Ô∏è  Git tag: v$(PackageVersion)"
        displayName: 'Publish Summary'

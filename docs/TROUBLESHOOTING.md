# Troubleshooting Guide

This guide covers common issues when using `@qops/hub-kit` and how to resolve them.

---

## "0 functions found" when running `func start`

### Problem

When running `func start`, you see:

```
[2024-01-09T11:58:07.818Z] 0 functions found
[2024-01-09T11:58:07.893Z] No job functions found.
```

### Causes

1. **Running in the wrong directory**: You might be trying to run `func start` in the `@qops/hub-kit` library repository instead of your own Azure Functions project.
2. **Missing build step**: TypeScript files haven't been compiled to JavaScript.
3. **Missing `main` field in package.json**: Azure Functions can't find your compiled function files.
4. **Wrong directory structure**: Functions aren't in the expected location.

### Solutions

#### Solution 1: Use the Example Project

If you're trying to see `@qops/hub-kit` in action:

```bash
# Clone the repository
git clone https://github.com/johanpearson/qops-hub-kit.git
cd qops-hub-kit

# Build the library
npm install
npm run build

# Navigate to the example
cd example
npm install
npm link @qops/hub-kit

# Build and run
npm run build
func start
```

You should now see 5 functions loaded:

- `health`
- `login`
- `getUser`
- `listUsers`
- `openapi`

#### Solution 2: Create Your Own Project

If you want to create your own Azure Functions project:

1. **Create a new directory** (don't use the library directory):

```bash
mkdir my-api
cd my-api
```

2. **Initialize your project**:

```bash
npm init -y
```

3. **Install dependencies**:

```bash
npm install @qops/hub-kit zod jsonwebtoken @azure/functions
npm install -D @types/node @types/jsonwebtoken typescript
```

4. **Add required fields to `package.json`**:

```json
{
  "type": "module",
  "main": "dist/functions/*.js"
}
```

5. **Create required configuration files**:

- `tsconfig.json` - TypeScript compiler configuration
- `host.json` - Azure Functions runtime configuration
- `local.settings.json` - Local environment variables

See [`example/`](../example) for complete configuration examples.

6. **Create your functions** in `src/functions/` directory.

7. **Build before running**:

```bash
npm run build
func start
```

#### Solution 3: Verify Project Structure

Ensure your project has this structure:

```
my-api/
├── dist/               # Compiled JavaScript (generated by build)
│   └── functions/      # Must contain *.js files
│       ├── health.js
│       └── ...
├── src/                # Your TypeScript source
│   └── functions/      # Function handlers
│       ├── health.ts
│       └── ...
├── package.json        # Must have "type": "module" and "main": "dist/functions/*.js"
├── tsconfig.json       # Must have "outDir": "dist"
└── host.json
```

---

## "Cannot find module '@qops/hub-kit'"

### Problem

When building or running, you see:

```
Error: Cannot find module '@qops/hub-kit'
```

### Solutions

#### For Published Package

Install the package:

```bash
npm install @qops/hub-kit
```

#### For Local Development

If working with the repository locally:

```bash
# In the @qops/hub-kit directory
npm install
npm run build
npm link

# In your project directory
npm link @qops/hub-kit
```

---

## Functions Build Successfully but Don't Register

### Problem

TypeScript compiles without errors, but `func start` shows "0 functions found".

### Checklist

1. **Verify `main` field in `package.json`**:

```json
{
  "main": "dist/functions/*.js"
}
```

2. **Check compiled output**:

```bash
ls dist/functions/
# Should show .js files
```

3. **Verify function registration** in compiled files:

```javascript
// Each function file should have:
import { app } from '@azure/functions';

app.http('functionName', {
  methods: ['GET'],
  authLevel: 'anonymous',
  route: 'path',
  handler: yourHandler,
});
```

4. **Check `host.json` exists** in project root:

```json
{
  "version": "2.0",
  "extensionBundle": {
    "id": "Microsoft.Azure.Functions.ExtensionBundle",
    "version": "[4.*, 5.0.0)"
  }
}
```

---

## JWT Authentication Fails

### Problem

Protected endpoints return 401 Unauthorized even with a valid token.

### Solutions

1. **Set JWT_SECRET environment variable**:

In `local.settings.json`:

```json
{
  "Values": {
    "JWT_SECRET": "your-secret-key-here"
  }
}
```

2. **Verify token claims**:

JWT tokens must include:

- `sub` - User ID
- `email` - User email
- `name` - User name
- `role` - User role ('admin' or 'member')

3. **Check token format**:

Authorization header must use Bearer scheme:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## TypeScript Compilation Errors

### Problem

`npm run build` fails with TypeScript errors.

### Solutions

1. **Verify TypeScript configuration** in `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "node",
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  }
}
```

2. **Install all type definitions**:

```bash
npm install -D @types/node @types/jsonwebtoken @azure/functions
```

3. **Use `.js` extension in imports**:

Since we're using ES modules, import statements need `.js` extensions:

```typescript
// ✅ Correct
import { loginSchema } from '../schemas/user.schemas.js';

// ❌ Wrong
import { loginSchema } from '../schemas/user.schemas';
```

---

## Validation Errors

### Problem

Requests fail with validation errors even when data looks correct.

### Solutions

1. **Check Zod schema matches your data**:

```typescript
const schema = z.object({
  email: z.string().email(), // Must be valid email
  age: z.number().int(), // Must be integer, not string
});
```

2. **Verify request Content-Type**:

For JSON bodies, use:

```
Content-Type: application/json
```

3. **Check for extra fields**:

By default, Zod strips unknown fields. If you need to preserve them:

```typescript
const schema = z.object({...}).passthrough();
```

---

## OpenAPI Documentation Not Generating

### Problem

OpenAPI endpoint returns empty or incorrect documentation.

### Solutions

1. **Verify schema registration**:

```typescript
builder.registerRoute({
  method: 'GET',
  path: '/api/users',
  summary: 'List users',
  responses: {
    200: {
      description: 'Success',
      schema: usersListSchema, // Must be a Zod schema
    },
  },
});
```

2. **Use path parameters correctly**:

```typescript
// For paths like /api/users/{id}
builder.registerRoute({
  path: '/api/users/{id}',
  pathParams: z.object({
    id: z.string().describe('User ID'),
  }),
  // ...
});
```

3. **Check schema exports**:

Ensure all schemas are exported from their modules:

```typescript
export const userResponseSchema = z.object({...});
```

---

## Port Already in Use

### Problem

`func start` fails with "Port 7071 is already in use".

### Solution

Specify a different port:

```bash
func start --port 7072
```

Or stop the existing process using port 7071.

---

## Still Having Issues?

1. **Check the example**: Compare your project with the working [`example/`](../example) directory
2. **Review documentation**: See [Getting Started Guide](./GETTING-STARTED.md)
3. **Report an issue**: [GitHub Issues](https://github.com/johanpearson/qops-hub-kit/issues)

Include in your issue:

- Node.js version (`node --version`)
- Azure Functions Core Tools version (`func --version`)
- Error messages and logs
- Your `package.json` and `tsconfig.json`

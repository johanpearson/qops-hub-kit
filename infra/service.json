{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "117019376775167016"
    }
  },
  "parameters": {
    "serviceName": {
      "type": "string",
      "metadata": {
        "description": "Service name (use your service name)"
      }
    },
    "environment": {
      "type": "string",
      "metadata": {
        "description": "Environment (dev, test, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Primary location"
      }
    },
    "jwtSecret": {
      "type": "securestring",
      "metadata": {
        "description": "JWT secret for authentication"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Key Vault name from common resources"
      }
    },
    "functionAppSku": {
      "type": "string",
      "defaultValue": "Y1",
      "allowedValues": [
        "Y1"
      ],
      "metadata": {
        "description": "App Service Plan SKU (Y1=Consumption - cheapest)"
      }
    },
    "additionalAppSettings": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Additional app settings for Function App"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Additional tags"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[format('rg-qops-{0}-{1}-{2}', parameters('serviceName'), parameters('environment'), parameters('location'))]",
    "functionAppName": "[format('func-qops-{0}-{1}-{2}', parameters('serviceName'), parameters('environment'), uniqueString(subscription().subscriptionId, parameters('serviceName'), parameters('environment')))]",
    "storageAccountName": "[format('stqops{0}{1}{2}', parameters('serviceName'), parameters('environment'), uniqueString(subscription().subscriptionId, parameters('serviceName'), parameters('environment')))]",
    "appInsightsName": "[format('appi-qops-{0}-{1}', parameters('serviceName'), parameters('environment'))]",
    "skuTier": "Dynamic"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-{0}-rg', parameters('serviceName'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceGroupName": {
            "value": "[variables('resourceGroupName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "serviceName": {
            "value": "[parameters('serviceName')]"
          },
          "additionalTags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17569353244706782135"
            }
          },
          "parameters": {
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Name of the resource group"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource group"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, test, prod)"
              }
            },
            "serviceName": {
              "type": "string",
              "defaultValue": "common",
              "metadata": {
                "description": "Service name"
              }
            },
            "additionalTags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional tags to apply to the resource group"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[parameters('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('additionalTags'))]"
            }
          ],
          "outputs": {
            "resourceGroupName": {
              "type": "string",
              "value": "[parameters('resourceGroupName')]"
            },
            "resourceGroupId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
            },
            "location": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName')), '2021-04-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-{0}-storage', parameters('serviceName'))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[take(variables('storageAccountName'), 24)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "serviceName": {
            "value": "[parameters('serviceName')]"
          },
          "skuName": {
            "value": "Standard_LRS"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13690966252651041778"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account (must be globally unique)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the storage account"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, test, prod)"
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS"
              ],
              "metadata": {
                "description": "Storage account SKU (Standard_LRS only - cheapest option)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "[parameters('skuName')]"
              },
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "accessTier": "Hot",
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "table": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              },
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('tags'))]"
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "primaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-{0}-rg', parameters('serviceName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-{0}-appinsights', parameters('serviceName'))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "serviceName": {
            "value": "[parameters('serviceName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2397849784632451114"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights instance"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for Application Insights"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, test, prod)"
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service name"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-workspace', parameters('appInsightsName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              },
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('tags'))]"
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('appInsightsName')))]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('tags'))]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('appInsightsName')))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('appInsightsName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-{0}-rg', parameters('serviceName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('deploy-{0}-function', parameters('serviceName'))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[take(variables('functionAppName'), 60)]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "serviceName": {
            "value": "[parameters('serviceName')]"
          },
          "storageAccountConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-storage', parameters('serviceName'))), '2025-04-01').outputs.connectionString.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-appinsights', parameters('serviceName'))), '2025-04-01').outputs.connectionString.value]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "jwtSecret": {
            "value": "[parameters('jwtSecret')]"
          },
          "skuName": {
            "value": "[parameters('functionAppSku')]"
          },
          "skuTier": {
            "value": "[variables('skuTier')]"
          },
          "additionalAppSettings": {
            "value": "[parameters('additionalAppSettings')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12632337838752326829"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Function App (must be globally unique)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the Function App"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, test, prod)"
              }
            },
            "serviceName": {
              "type": "string",
              "metadata": {
                "description": "Service name"
              }
            },
            "storageAccountConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage account connection string for Function App"
              }
            },
            "appInsightsConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for secret references"
              }
            },
            "jwtSecret": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "JWT secret (will be stored as app setting)"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Y1",
              "allowedValues": [
                "Y1"
              ],
              "metadata": {
                "description": "App Service Plan SKU (Y1=Consumption - only option for cost optimization)"
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Dynamic",
              "allowedValues": [
                "Dynamic"
              ],
              "metadata": {
                "description": "App Service Plan tier (Dynamic=Consumption)"
              }
            },
            "additionalAppSettings": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional app settings"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Additional tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}-plan', parameters('functionAppName'))]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "properties": {
                "reserved": true
              },
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('tags'))]"
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('{0}-plan', parameters('functionAppName')))]",
                "reserved": true,
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "NODE|22",
                  "appSettings": "[concat(createArray(createObject('name', 'AzureWebJobsStorage', 'value', parameters('storageAccountConnectionString')), createObject('name', 'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING', 'value', parameters('storageAccountConnectionString')), createObject('name', 'WEBSITE_CONTENTSHARE', 'value', toLower(parameters('functionAppName'))), createObject('name', 'FUNCTIONS_EXTENSION_VERSION', 'value', '~4'), createObject('name', 'FUNCTIONS_WORKER_RUNTIME', 'value', 'node'), createObject('name', 'WEBSITE_NODE_DEFAULT_VERSION', 'value', '~22'), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', parameters('appInsightsConnectionString')), createObject('name', 'ApplicationInsightsAgent_EXTENSION_VERSION', 'value', '~3')), if(not(empty(parameters('jwtSecret'))), createArray(createObject('name', 'JWT_SECRET', 'value', parameters('jwtSecret'))), createArray()), if(not(empty(parameters('keyVaultName'))), createArray(createObject('name', 'KEY_VAULT_NAME', 'value', parameters('keyVaultName'))), createArray()), parameters('additionalAppSettings'))]",
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com"
                    ]
                  },
                  "use32BitWorkerProcess": false,
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2"
                }
              },
              "tags": "[union(createObject('Environment', parameters('environment'), 'Service', parameters('serviceName'), 'ManagedBy', 'IaC', 'Project', 'QOPS', 'Owner', 'Johan Pearson'), parameters('tags'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('{0}-plan', parameters('functionAppName')))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "functionAppHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName)]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', format('{0}-plan', parameters('functionAppName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-appinsights', parameters('serviceName')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-{0}-rg', parameters('serviceName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-storage', parameters('serviceName')))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-{0}-rg', parameters('serviceName'))), '2025-04-01').outputs.resourceGroupName.value]"
    },
    "functionAppName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-function', parameters('serviceName'))), '2025-04-01').outputs.functionAppName.value]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-function', parameters('serviceName'))), '2025-04-01').outputs.functionAppUrl.value]"
    },
    "functionAppPrincipalId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-function', parameters('serviceName'))), '2025-04-01').outputs.principalId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-storage', parameters('serviceName'))), '2025-04-01').outputs.storageAccountName.value]"
    },
    "storageAccountConnectionString": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-storage', parameters('serviceName'))), '2025-04-01').outputs.connectionString.value]"
    },
    "appInsightsName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-{0}-appinsights', parameters('serviceName'))), '2025-04-01').outputs.appInsightsName.value]"
    }
  }
}
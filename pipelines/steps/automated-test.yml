# Automated Test Step Template
# Clones test repository and runs automated/E2E tests

parameters:
  - name: testRepoUrl
    type: string
    displayName: 'Test repository URL (required)'
  
  - name: testRepoBranch
    type: string
    default: 'main'
    displayName: 'Test repository branch'
  
  - name: testScript
    type: string
    default: 'npm test'
    displayName: 'Test script to run'
  
  - name: workingDirectory
    type: string
    default: 'automated-tests'
    displayName: 'Directory to clone tests into'
  
  - name: nodeVersion
    type: string
    default: '22.x'
    displayName: 'Node.js version for test execution'
  
  - name: publishResults
    type: boolean
    default: true
    displayName: 'Publish test results'

steps:
  - checkout: none
    displayName: 'Skip default checkout'

  - script: |
      git clone --branch ${{ parameters.testRepoBranch }} ${{ parameters.testRepoUrl }} ${{ parameters.workingDirectory }}
    displayName: 'Clone test repository'

  - task: NodeTool@0
    displayName: 'Install Node.js ${{ parameters.nodeVersion }}'
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}

  - script: npm ci
    displayName: 'Install test dependencies'
    workingDirectory: ${{ parameters.workingDirectory }}

  - script: ${{ parameters.testScript }}
    displayName: 'Run automated tests'
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      # Pass any environment variables needed for tests
      BASE_URL: $(BASE_URL)
      API_KEY: $(API_KEY)

  - ${{ if eq(parameters.publishResults, true) }}:
    - task: PublishTestResults@2
      displayName: 'Publish automated test results'
      condition: succeededOrFailed()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/junit.xml'
        searchFolder: ${{ parameters.workingDirectory }}
        failTaskOnFailedTests: true
        testRunTitle: 'Automated Tests'
        mergeTestResults: true
